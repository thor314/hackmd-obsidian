name: Check Changelog

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  check-changelog:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      statuses: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changelog update
        id: check
        run: |
          # Skip check if PR has "no-changelog" label
          if gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name' | grep -q "no-changelog"; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "✓ Skipping changelog check (no-changelog label present)"
            exit 0
          fi

          # Get the base branch
          git fetch origin ${{ github.base_ref }}

          # Check if CHANGELOG.md was modified in this PR
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^CHANGELOG.md$"; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "updated=true" >> "$GITHUB_OUTPUT"
            echo "✓ CHANGELOG.md has been updated"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "updated=false" >> "$GITHUB_OUTPUT"
            echo "✗ CHANGELOG.md has not been updated"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update PR status
        if: steps.check.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const updated = '${{ steps.check.outputs.updated }}' === 'true'

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: updated ? 'success' : 'failure',
              context: 'changelog/update',
              description: updated
                ? 'CHANGELOG.md has been updated'
                : 'Please update CHANGELOG.md',
              target_url: 'https://github.com/${{ github.repository }}/blob/${{ github.base_ref }}/CHANGELOG.md'
            })

            if (!updated) {
              core.setFailed('CHANGELOG.md has not been updated. Please add an entry to the [Unreleased] section, or add the "no-changelog" label if no changelog entry is needed.')
            }